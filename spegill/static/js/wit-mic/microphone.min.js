var Microphone,VERSION,WEBSOCKET_HOST,WitError,log,states;VERSION="0.8.0",navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,function(){var t,e,n,i,r,o,s,c;for(c=window,r=["ms","moz","webkit","o"],n=0,i=r.length;i>n&&(s=r[n],!c.requestAnimationFrame);n++)c.requestAnimationFrame=c[s+"RequestAnimationFrame"],c.cancelAnimationFrame=c[s+"CancelAnimationFrame"]||c[s+"CancelRequestAnimationFrame"];if(c.requestAnimationFrame){if(c.cancelAnimationFrame)return;return t=c.requestAnimationFrame,e={},c.requestAnimationFrame=function(n){var i;return i=t(function(t){return i in e?delete e[i]:n(t)})},c.cancelAnimationFrame=function(t){return e[t]=!0}}return o=0,c.requestAnimationFrame=function(t){var e;return o=Math.max(o+16,e=+new Date),c.setTimeout(function(){return t(+new Date)},o-e)},c.cancelAnimationFrame=function(t){return clearTimeout(t)}}(),log=("undefined"!=typeof localStorage&&null!==localStorage?localStorage.getItem:void 0)&&localStorage.getItem("wit_debug")?function(){return console.log.apply(console,arguments)}:function(){},WitError=function(t,e){return this.name="WitError",this.message=t||"",this.infos=e,this},WitError.prototype=Error.prototype,WEBSOCKET_HOST="wss://api.wit.ai/speech_ws",Microphone=function(t){var e,n;return this.conn=null,this.ctx=new AudioContext,this.state="disconnected",this.rec=!1,this.handleError=function(t){var e,n;return _.isFunction(n=this.onerror)?(e=_.isString(t)?t:_.isString(t.message)?t.message:"Something went wrong!",n.call(window,e,t)):void 0},this.handleResult=function(t){var e,n,i,r;return _.isFunction(n=this.onresult)?(r=t.outcome.intent,e=t.outcome.entities,i=t.outcome._text,n.call(window,r,e,i,t)):void 0},t&&(this.elem=t,t.innerHTML="<div class='mic mic-box icon-wit-mic'>\n</div>\n<svg class='mic-svg mic-box'>\n</svg>",t.className+=" wit-microphone",t.addEventListener("click",function(t){return function(){return t.fsm("toggle_record")}}(this)),n=this.elem.children[1],e="http://www.w3.org/2000/svg",this.path=document.createElementNS(e,"path"),this.path.setAttribute("stroke","#eee"),this.path.setAttribute("stroke-width","5"),this.path.setAttribute("fill","none"),n.appendChild(this.path)),this.rmactive=function(){return this.elem?this.elem.classList.remove("active"):void 0},this.mkactive=function(){return this.elem?this.elem.classList.add("active"):void 0},this.mkthinking=function(){var t,e,i,r,o,s,c,a,u,h,d,m,l;return this.thinking=!0,this.elem?(u=getComputedStyle(n),this.elem.classList.add("thinking"),m=parseInt(u.width,10),o=parseInt(u.height,10),e="border-box"===u.boxSizing?parseInt(u.borderTopWidth,10):0,s=m/2-e-5,t=1e3,i=m/2-e,r=o/2-e-s,l=0,h=1,a=(null!=(c=window.performance)?c.now():void 0)||new Date,d=function(n){return function(c){var u,f,g,p;return f=(c-a)%t/t*2*Math.PI-Math.PI/2,g=Math.cos(f)*s+m/2-e,p=Math.sin(f)*s+o/2-e,u=+(1.5*Math.PI>f&&f>Math.PI/2),n.path.setAttribute("d","M"+i+","+r+"A"+s+","+s+","+l+","+u+","+h+","+g+","+p),n.thinking?requestAnimationFrame(d):(n.elem.classList.remove("thinking"),n.path.setAttribute("d","M0,0"))}}(this),requestAnimationFrame(d)):void 0},this.rmthinking=function(){return this.thinking=!1},this},states={disconnected:{connect:function(t){var e,n;return t||this.handleError("No token provided"),e=new WebSocket(WEBSOCKET_HOST),e.onopen=function(){return function(n){var i;return log("connection opened",n),i={token:t,bps:16,encoding:"signed-integer"},e.send(JSON.stringify(["auth",i]))}}(this),e.onclose=function(t){return function(){return t.fsm("socket_closed")}}(this),e.onmessage=function(t){return function(e){var n,i,r;return i=JSON.parse(e.data),r=i[0],n=i[1],n?t.fsm.call(t,r,n):t.fsm.call(t,r)}}(this),this.conn=e,n=function(t){return function(e){var n,i,r;return n=t.ctx,r=n.createMediaStreamSource(e),i=(n.createScriptProcessor||n.createJavascriptNode).call(n,4096,1,1),i.onaudioprocess=function(e){var n,i,r,o,s,c,a,u,h;if(t.rec){for(n=e.inputBuffer,i=n.getChannelData(0),c=i.length,o=new Int16Array(c),r=s=0,a=c;a>=0?a>=s:s>=a;r=a>=0?++s:--s)u=i[r],h=0>u?32768*u:32767*u,o[r]=h;return log("[audiobuffer] rate="+n.sampleRate+", samples="+c+", bytes="+o.byteLength),t.conn.send(o)}},r.connect(i),i.connect(n.destination),t.stream=e,t.proc=i,t.src=r,t.fsm("got_stream")}}(this),navigator.getUserMedia({audio:!0},n,this.handleError),"connecting"}},connecting:{"auth-ok":function(){return"waiting_for_stream"},got_stream:function(){return"waiting_for_auth"},error:function(t){return this.handleError(t),"connecting"},socket_closed:function(){return"disconnected"}},waiting_for_auth:{"auth-ok":function(){return"ready"}},waiting_for_stream:{got_stream:function(){return"ready"}},ready:{socket_closed:function(){return"disconnected"},timeout:function(){return"ready"},start:function(){return this.fsm("toggle_record")},toggle_record:function(){return this.conn.send(JSON.stringify(["start",this.context||{}])),this.rec=!0,this.ctx||console.error("No context"),this.stream||console.error("No stream"),this.src||console.error("No source"),this.proc||console.error("No processor"),"audiostart"}},audiostart:{error:function(t){return this.rec=!1,this.handleError(new WitError("Error during recording",{code:"RECORD",data:t})),"ready"},socket_closed:function(){return this.rec=!1,"disconnected"},stop:function(){return this.fsm("toggle_record")},toggle_record:function(){return this.rec=!1,this.conn.send(JSON.stringify(["stop"])),this.timer=setTimeout(function(t){return function(){return t.fsm("timeout")}}(this),6e4),"audioend"}},audioend:{socket_closed:function(){return this.timer&&clearTimeout(this.timer),"disconnected"},timeout:function(){return this.handleError(new WitError("Wit timed out",{code:"TIMEOUT"})),"ready"},error:function(t){return this.timer&&clearTimeout(this.timer),this.handleError(new WitError("Wit did not recognize intent",{code:"RESULT",data:t})),"ready"},result:function(t){return this.timer&&clearTimeout(this.timer),this.handleResult(t),"ready"}}},Microphone.prototype.fsm=function(t){var e,n,i,r;if(n=null!=(i=states[this.state])?i[t]:void 0,e=Array.prototype.slice.call(arguments,1),_.isFunction(n))switch(r=n.apply(this,e),log("fsm: "+this.state+" + "+t+" -> "+r,e),this.state=r,("audiostart"===r||"audioend"===r||"ready"===r||"connecting"===r||"disconnected"===r)&&_.isFunction(n=this["on"+r])&&n.call(window),r){case"disconnected":this.rmthinking(),this.rmactive();break;case"ready":this.rmthinking(),this.rmactive();break;case"audiostart":this.mkactive();break;case"audioend":this.mkthinking(),this.rmactive()}else log("fsm error: "+this.state+" + "+t,e);return r},Microphone.prototype.connect=function(t){return this.fsm("connect",t)},Microphone.prototype.start=function(){return this.fsm("start")},Microphone.prototype.stop=function(){return this.fsm("stop")},Microphone.prototype.setContext=function(t){var e,n;this.context||(this.context={});for(e in t)n=t[e],this.context[e]=t[e];return log("context: ",this.context),null},window._||(window._={}),_.isFunction||(_.isFunction=function(t){return"function"==typeof t}),_.isString||(_.isString=function(t){return"[object String]"===toString.call(t)}),window.Wit||(window.Wit={}),Wit.Microphone=Microphone;
